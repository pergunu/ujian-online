<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ujian Online - PERGUNU SITUBONDO</title>
    <link rel="stylesheet" href="../assets/css/style.css">
</head>
<body>
    <div id="particles-js"></div>
    <div class="container exam-container">
        <div class="exam-header">
            <div class="exam-info">
                <h1 id="exam-title">Ujian Online</h1>
                <div class="timer" id="exam-timer">02:00:00</div>
            </div>
            
            <div class="progress-container">
                <div class="progress-bar" id="progress-bar"></div>
                <div class="progress-text" id="progress-text">0/10</div>
            </div>
        </div>
        
        <div class="exam-content">
            <div class="question-box" id="question-box">
                <!-- Questions will be loaded here by JavaScript -->
            </div>
            
            <div class="exam-controls">
                <button id="finish-exam" class="btn-control finish-btn">
                    <i class="fas fa-flag-checkered"></i> Selesaikan Ujian Sekarang
                </button>
                <button id="skip-question" class="btn-control skip-btn">
                    <i class="fas fa-forward"></i> Lewati Soal
                </button>
                <button id="unanswered-questions" class="btn-control unanswered-btn">
                    <i class="fas fa-question-circle"></i> Soal Belum Dijawab
                </button>
            </div>
        </div>
        
        <div id="time-warning" class="time-warning">
            <p>Perhatian! Ujian akan berakhir dalam waktu 10 menit. Mohon pastikan semua jawaban telah diselesaikan dan diperiksa sebelum waktu habis. Terima kasih atas partisipasi Anda.</p>
        </div>
    </div>
    
    <!-- Floating Buttons (hidden during exam) -->
    <div class="floating-buttons" style="display: none;">
        <button class="floating-btn share-btn" title="Bagikan">
            <i class="fas fa-share-alt"></i>
        </button>
        <button class="floating-btn whatsapp-btn" title="Chat Admin">
            <i class="fab fa-whatsapp"></i>
        </button>
    </div>
    
    <!-- Audio Elements -->
    <audio id="correct-audio" src="../assets/audio/jawabanbenar.mp3" preload="auto"></audio>
    <audio id="wrong-audio" src="../assets/audio/jawabansalah.mp3" preload="auto"></audio>
    
    <script src="../assets/js/particles.js"></script>
    <script src="../assets/js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Load exam data
            const examSelection = JSON.parse(sessionStorage.getItem('examSelection'));
            const participantData = JSON.parse(sessionStorage.getItem('participantData'));
            
            // Set exam title
            let examTitle = '';
            if (examSelection.type === 'pelajar') {
                examTitle = `Ujian ${examSelection.subject.toUpperCase()} - Kelas ${examSelection.grade.toUpperCase()}`;
            } else {
                examTitle = examSelection.exam === 'logika' ? 'Ujian Logika' : 'Ujian CPNS/P3K';
            }
            document.getElementById('exam-title').textContent = examTitle;
            
            // Timer functionality
            let timeLeft = 120 * 60; // 120 minutes in seconds
            const timerElement = document.getElementById('exam-timer');
            const timeWarning = document.getElementById('time-warning');
            
            function updateTimer() {
                const hours = Math.floor(timeLeft / 3600);
                const minutes = Math.floor((timeLeft % 3600) / 60);
                const seconds = timeLeft % 60;
                
                timerElement.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                // Show warning when 10 minutes left
                if (timeLeft === 600) { // 10 minutes = 600 seconds
                    timeWarning.style.display = 'block';
                    setTimeout(() => {
                        timeWarning.style.display = 'none';
                    }, 540000); // Hide after 9 minutes (leaving 1 minute)
                }
                
                // Make timer bigger when 10 minutes left
                if (timeLeft <= 600) {
                    timerElement.style.fontSize = '2rem';
                    timerElement.style.color = '#ff6b6b';
                }
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    finishExam(true);
                } else {
                    timeLeft--;
                }
            }
            
            const timerInterval = setInterval(updateTimer, 1000);
            
            // Load questions (mock data - in real app, this would come from a database)
            const questions = loadQuestions(examSelection);
            let currentQuestionIndex = 0;
            let answeredQuestions = 0;
            let correctAnswers = 0;
            const userAnswers = new Array(questions.length).fill(null);
            
            // Display first question
            displayQuestion(currentQuestionIndex);
            
            // Update progress
            function updateProgress() {
                const progress = (answeredQuestions / questions.length) * 100;
                document.getElementById('progress-bar').style.width = `${progress}%`;
                document.getElementById('progress-text').textContent = `${answeredQuestions}/${questions.length}`;
            }
            
            // Display question
            function displayQuestion(index) {
                const questionBox = document.getElementById('question-box');
                const question = questions[index];
                
                questionBox.innerHTML = `
                    <div class="question-number">Soal ${index + 1} dari ${questions.length}</div>
                    <div class="question-text">${question.text}</div>
                    
                    <div class="options-container">
                        ${question.options.map((option, i) => `
                            <div class="option" data-option="${i}">
                                <div class="option-letter">${String.fromCharCode(65 + i)}</div>
                                <div class="option-text">${option}</div>
                            </div>
                        `).join('')}
                    </div>
                    
                    ${userAnswers[index] !== null ? `
                        <div class="answer-explanation">
                            <h3>Penjelasan Jawaban:</h3>
                            <p>${question.explanation}</p>
                        </div>
                    ` : ''}
                `;
                
                // Highlight selected answer if exists
                if (userAnswers[index] !== null) {
                    const selectedOption = document.querySelector(`.option[data-option="${userAnswers[index]}"]`);
                    if (selectedOption) {
                        const isCorrect = userAnswers[index] === question.correctAnswer;
                        selectedOption.classList.add(isCorrect ? 'correct' : 'incorrect');
                    }
                }
                
                // Add event listeners to options
                document.querySelectorAll('.option').forEach(option => {
                    option.addEventListener('click', function() {
                        if (userAnswers[index] !== null) return; // Already answered
                        
                        const selectedOption = parseInt(this.getAttribute('data-option'));
                        userAnswers[index] = selectedOption;
                        
                        // Check if answer is correct
                        const isCorrect = selectedOption === question.correctAnswer;
                        
                        // Update stats
                        if (isCorrect) correctAnswers++;
                        answeredQuestions++;
                        
                        // Play sound
                        const audio = isCorrect ? document.getElementById('correct-audio') : document.getElementById('wrong-audio');
                        audio.currentTime = 0;
                        audio.play().catch(e => console.log("Audio play prevented:", e));
                        
                        // Visual feedback
                        this.classList.add(isCorrect ? 'correct' : 'incorrect');
                        
                        // Show explanation
                        const explanationDiv = document.createElement('div');
                        explanationDiv.className = 'answer-explanation';
                        explanationDiv.innerHTML = `
                            <h3>Penjelasan Jawaban:</h3>
                            <p>${question.explanation}</p>
                        `;
                        questionBox.appendChild(explanationDiv);
                        
                        // Update progress
                        updateProgress();
                        
                        // Auto move to next question after delay if not last question
                        if (index < questions.length - 1) {
                            setTimeout(() => {
                                currentQuestionIndex++;
                                displayQuestion(currentQuestionIndex);
                            }, 2000);
                        }
                    });
                });
            }
            
            // Skip question
            document.getElementById('skip-question').addEventListener('click', function() {
                if (currentQuestionIndex < questions.length - 1) {
                    currentQuestionIndex++;
                    displayQuestion(currentQuestionIndex);
                } else {
                    alert('Ini adalah soal terakhir.');
                }
            });
            
            // Unanswered questions
            document.getElementById('unanswered-questions').addEventListener('click', function() {
                const unansweredIndices = [];
                for (let i = 0; i < userAnswers.length; i++) {
                    if (userAnswers[i] === null) {
                        unansweredIndices.push(i);
                    }
                }
                
                if (unansweredIndices.length === 0) {
                    alert('Semua soal telah dijawab.');
                } else {
                    currentQuestionIndex = unansweredIndices[0];
                    displayQuestion(currentQuestionIndex);
                }
            });
            
            // Finish exam
            document.getElementById('finish-exam').addEventListener('click', function() {
                const unanswered = questions.length - answeredQuestions;
                
                if (unanswered > 0) {
                    const confirmFinish = confirm(`Anda memiliki ${unanswered} soal yang belum dijawab. Yakin ingin menyelesaikan ujian sekarang?`);
                    if (confirmFinish) {
                        finishExam(false);
                    }
                } else {
                    finishExam(false);
                }
            });
            
            // Finish exam function
            function finishExam(timeout = false) {
                clearInterval(timerInterval);
                
                // Calculate score
                const score = Math.round((correctAnswers / questions.length) * 100);
                
                // Save result
                sessionStorage.setItem('examResult', JSON.stringify({
                    examTitle,
                    totalQuestions: questions.length,
                    correctAnswers,
                    wrongAnswers: answeredQuestions - correctAnswers,
                    unanswered: questions.length - answeredQuestions,
                    score,
                    participantData
                }));
                
                // Redirect to result page
                window.location.href = 'result.html';
            }
            
            // Load questions function (mock data)
            function loadQuestions(examSelection) {
                // In a real app, this would be fetched from a database
                // Here we provide mock questions for demonstration
                
                let questions = [];
                
                if (examSelection.type === 'pelajar') {
                    // Sample questions for students
                    questions = [
                        {
                            text: "Apa ibukota Indonesia?",
                            options: ["Jakarta", "Bandung", "Surabaya", "Medan", "Yogyakarta"],
                            correctAnswer: 0,
                            explanation: "Jakarta adalah ibukota Indonesia sejak tahun 1945."
                        },
                        {
                            text: "Siapa presiden pertama Indonesia?",
                            options: ["Soeharto", "Joko Widodo", "Soekarno", "BJ Habibie", "Susilo Bambang Yudhoyono"],
                            correctAnswer: 2,
                            explanation: "Ir. Soekarno adalah presiden pertama Indonesia yang menjabat dari tahun 1945 hingga 1967."
                        }
                    ];
                } else if (examSelection.exam === 'logika') {
                    // Sample questions for logic test
                    questions = [
                        {
                            text: "Jika semua manusia adalah makhluk hidup, dan Andi adalah manusia, maka:",
                            options: ["Andi adalah makhluk hidup", "Andi bukan makhluk hidup", "Makhluk hidup adalah Andi", "Tidak dapat disimpulkan", "Semua salah"],
                            correctAnswer: 0,
                            explanation: "Berdasarkan premis, jika semua manusia adalah makhluk hidup dan Andi adalah manusia, maka Andi adalah makhluk hidup."
                        }
                    ];
                } else {
                    // Sample questions for CPNS test
                    questions = [
                        {
                            text: "Pancasila sebagai dasar negara tercantum dalam:",
                            options: ["Pembukaan UUD 1945", "Batang Tubuh UUD 1945", "Penjelasan UUD 1945", "Keputusan Presiden", "Tap MPR"],
                            correctAnswer: 0,
                            explanation: "Pancasila sebagai dasar negara tercantum dalam alinea keempat Pembukaan UUD 1945."
                        }
                    ];
                }
                
                return questions;
            }
        });
    </script>
</body>
</html>
